# 09 - Travis, Coveralls –∏ Heroku

–ö–æ–¥–∞ –∑–∞ —Ç–∞–∑–∏ –≥–ª–∞–≤–∞ –º–æ–∂–µ—Ç–µ –¥–∞ –Ω–∞–º–µ—Ä–∏—Ç–µ –≤ `master` –∫–ª–æ–Ω–∞ –Ω–∞ [JS-Stack-Boilerplate repository](https://github.com/verekia/js-stack-boilerplate).

–í —Ç–∞–∑–∏ –≥–ª–∞–≤–∞ –∏–∑–ø–æ–ª–∑–≤–∞–º —É—Å–ª—É–≥–∏, –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—è–Ω–∏ –æ—Ç —Ç—Ä–µ—Ç–∏ —Å—Ç—Ä–∞–Ω–∏, –≤ –Ω–∞—à–µ—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ. –¢–µ–∑–∏ —É—Å–ª—É–≥–∏ —Å–µ –ø—Ä–µ–¥–ª–∞–≥–∞—Ç —Å –±–µ–∑–ø–ª–∞—Ç–Ω–∏ –∏ —Å –ø–ª–∞—Ç–µ–Ω–∏ –ø–ª–∞–Ω–æ–≤–µ. –©–µ –±—ä–¥–µ –º–∞–ª–∫–æ –ø—Ä–æ—Ç–∏–≤–æ—Ä–µ—á–∏–≤–æ –¥–∞ –∏–∑–ø–æ–ª–∑–≤–∞–º —Ç–∞–∫—ä–≤ —Ç–∏–ø —É—Å–ª—É–≥–∏ –≤ —Ç–æ–≤–∞ —Ä—ä–∫–æ–≤–æ–¥—Å—Ç–≤–æ,  —Ç—ä–π –∫–∞—Ç–æ —Ç–æ —Ä–∞–∑—á–∏—Ç–∞ –≥–ª–∞–≤–Ω–æ –Ω–∞ community-driven –∏ –±–µ–∑–ø–ª–∞—Ç–Ω–∏ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ —Å –æ—Ç–≤–æ—Ä–µ–Ω –∫–æ–¥, –ø–æ—Ä–∞–¥–∏ –∫–æ–µ—Ç–æ –ø–æ–¥–¥—ä—Ä–∂–∞–º 2 —Ä–∞–∑–ª–∏—á–Ω–∏ –∫–ª–æ–Ω–∞ –Ω–∞ [JS-Stack-Boilerplate repository](https://github.com/verekia/js-stack-boilerplate), `master` –∏ `master-no-services`.

## Travis

> üí° **[Travis CI](https://travis-ci.org/)** –µ –ø–æ–ø—É–ª—è—Ä–Ω–∞ continuous integration –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞, –±–µ–∑–ø–ª–∞—Ç–Ω–∞ –∑–∞ –ø—Ä–æ–µ–∫—Ç–∏ —Å –æ—Ç–≤–æ—Ä–µ–Ω –∫–æ–¥.

–ê–∫–æ –≤–∞—à–∏—è—Ç –ø—Ä–æ–µ–∫—Ç –µ –ø—É–±–ª–∏—á–Ω–æ –¥–æ—Å—Ç—ä–ø–µ–Ω –≤ Github, –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è—Ç–∞ —Å Travis –µ –º–Ω–æ–≥–æ –ª–µ—Å–Ω–∞. –ò–¥–µ–Ω—Ç–∏—Ñ–∏—Ü–∏—Ä–∞–π—Ç–µ —Å–µ —Å –≤–∞—à–∏—è Github –∞–∫–∞—É–Ω—Ç –≤ Travis –∏ –¥–æ–±–∞–≤–µ—Ç–µ –≤–∞—à–µ—Ç–æ —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏.

- –°–ª–µ–¥ —Ç–æ–≤–∞ —Å—ä–∑–¥–∞–π—Ç–µ `.travis.yml` —Ñ–∞–π–±, —Å—ä–¥—ä—Ä–∂–∞—â:

```yaml
language: node_js
node_js: node
script: yarn test && yarn prod:build
```

Travis —â–µ –∑–∞—Å–µ—á–µ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ, —á–µ –∏–∑–ø–æ–ª–∑–≤–∞—Ç–µ Yarn, –∑–∞—â–æ—Ç–æ –∏–º–∞—Ç–µ `yarn.lock` —Ñ–∞–π–±. –í—Å–µ–∫–∏ –ø—ä—Ç –∫–æ–≥–∞—Ç–æ –∑–∞–ø–∞–∑–≤–∞—Ç–µ –∫–æ–¥–∞ —Å–∏ –≤—ä–≤ –≤–∞—à–µ—Ç–æ Github —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏, —Ç–æ–π —â–µ —Å—Ç–∞—Ä—Ç–∏—Ä–∞ `yarn test && yarn prod:build`. –ê–∫–æ –≤—Å–∏—á–∫–æ –µ –Ω–∞—Ä–µ–¥, –±–∏ —Ç—Ä—è–±–≤–∞–ª–æ –±–∏–ª–¥—ä—Ç –≤–∏ –¥–∞ –µ —É—Å–ø–µ—à–µ–Ω (you should get a green build).

## Coveralls

> üí° **[Coveralls](https://coveralls.io)** –µ —É—Å–ª—É–≥–∞, –∫–æ—è—Ç–æ –≤–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—è –≤—ä–∑–º–æ–∂–Ω–æ—Å—Ç –¥–∞ –≤–∏–∂–¥–∞—Ç–µ –∏—Å—Ç–æ—Ä–∏—è—Ç–∞ –∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏—Ç–µ –Ω–∞ —Ç–µ—Å—Ç–æ–≤–æ—Ç–æ –ø–æ–∫—Ä–∏—Ç–∏–µ (test coverage) –Ω–∞ –≤–∞—à–µ—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ.

If your project is open-source on Github and compatible with Coveralls' supported Continuous Integration services, the only thing you need to do is to pipe the coverage file generated by Jest to the `coveralls` binary.

- Run `yarn add --dev coveralls`

- Edit your `.travis.yml`'s `script` instruction like so:

```yaml
script: yarn test && yarn prod:build && cat ./coverage/lcov.info | ./node_modules/coveralls/bin/coveralls.js
```

Now, every time Travis will build, it will automatically submit your Jest test coverage data to Coveralls.

## Badges

Is everything green on Travis and Coveralls? Great, show it off to the world with shiny badges!

You can use the code provided by Travis or Coveralls directly, or use [shields.io](http://shields.io/) to homogenize or customize your badges. Let's use shields.io here.

- Create or edit your `README.md` like so:

```md
[![Build Status](https://img.shields.io/travis/GITHUB-USERNAME/GITHUB-REPO.svg?style=flat-square)](https://travis-ci.org/GITHUB-USERNAME/GITHUB-REPO)
[![Coverage Status](https://img.shields.io/coveralls/GITHUB-USERNAME/GITHUB-REPO.svg?style=flat-square)](https://coveralls.io/github/GITHUB-USERNAME/GITHUB-REPO?branch=master)
```

Of course, replace `GITHUB-USERNAME/GITHUB-REPO` by your actual Github username and repository name.

## Heroku

> üí° **[Heroku](https://www.heroku.com/)** is a [PaaS](https://en.wikipedia.org/wiki/Platform_as_a_service) to deploy to. It takes care of infrastructure details, so you can focus on developing your app without worrying about what happens behind the scenes.

This tutorial is not sponsored in any way by Heroku, but Heroku being one hell of a platform, I am going to show you how to deploy your app to it. Yep, that's the kind of free love you get when you build a great product.

**Note**: I might add an AWS section in this chapter later, but one thing at a time.

### Web setup

- If that's not done yet, install the [Heroku CLI](https://devcenter.heroku.com/articles/getting-started-with-nodejs) and log in.

- Go to your [Heroku Dashboard](https://dashboard.heroku.com/) and create 2 apps, one called `your-project` and one called `your-project-staging` for instance.

We are going to let Heroku take care of transpiling our ES6/Flow code with Babel, and generate client bundles with Webpack. But since these are `devDependencies`, Yarn won't install them in a production environment like Heroku. Let's change this behavior with the `NPM_CONFIG_PRODUCTION` env variable.

- In both apps, under Settings > Config Variables, add `NPM_CONFIG_PRODUCTION` set to `false`.

- Create a Pipeline, and grant Heroku access to your Github.

- Add both apps to the pipeline, make the staging one auto-deploy on changes in `master`, and enable Review Apps.

Alright, let's prepare our project for a deployment to Heroku.

### Running in production mode locally

- Create a `.env` file containing:

```.env
NODE_ENV='production'
PORT='8000'
```

That's in this file that you should put your local-only variables and secret variables. Don't commit it to a public repository if your project is private.

- Add `/.env` to your `.gitignore`

- Create a `Procfile` file containing:

```Procfile
web: node lib/server
```

That's where we specify the entry point of our server.

We are not going to use PM2 anymore, we'll use `heroku local` instead to run in production mode locally.

- Run `yarn remove pm2`

- Edit your `prod:start` script in `package.json`:

```json
"prod:start": "heroku local",
```

- Remove `prod:stop` from `package.json`. We don't need it anymore since `heroku local` is a hanging process that we can kill with Ctrl+C, unlike `pm2 start`.

üèÅ Run `yarn prod:build` and `yarn prod:start`. It should start your server and show you the logs.

### Deploying to production

- Add the following line to your `scripts` in `package.json`:

```json
"heroku-postbuild": "yarn prod:build",
```

`heroku-postbuild` is a task that will be run every time you deploy an app to Heroku.

You will also probably want to specify a specific version of Node or Yarn for Heroku to use.

- Add this to your `package.json`:

```json
"engines": {
  "node": "7.x",
  "yarn": "0.20.3"
},
```

- Create an `app.json` file containing:

```json
{
  "env": {
    "NPM_CONFIG_PRODUCTION": "false"
  }
}
```

This is for your Review Apps to use.

You should now be all set to use Heroku Pipeline deployments.

üèÅ Create a new git branch, make changes and open a Github Pull Request to instantiate a Review App. Check your changes on the Review App URL, and if everything looks good, merge your Pull Request with `master` on Github. A few minutes later, your staging app should have been automatically deployed. Check your changes on the staging app URL, and if everything still looks good, promote staging to production.

You are done! Congratulations if you finished this entire tutorial starting from scratch.

You deserve this emoji medal: üèÖ

Back to the [previous section](08-bootstrap-jss.md#readme) or the [table of contents](https://github.com/verekia/js-stack-from-scratch#table-of-contents).
